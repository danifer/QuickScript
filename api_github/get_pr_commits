#!/usr/bin/env php
<?php

# Documentation: https://docs.github.com/en/rest/pulls/pulls#list-commits-on-a-pull-request

$options = getopt('', [
    'repo:',
    'owner:',
    'pr:',
    'format:',
    'token:'
]);

$token = $options['token'] ?? getenv('GITHUB_TOKEN');
$format = $options['format'] ?? 'table';
$repo = $options['repo'] ?? null;
$owner = $options['owner'] ?? null;
$prNumber = $options['pr'] ?? null;

$allowedFormats = ['json', 'csv', 'table'];

if (empty($token)) {
    echo "No GITHUB_TOKEN supplied.\n";
    exit(1);
}

if (!in_array($format, $allowedFormats)) {
    echo sprintf('Invalid format. Valid formats are %s%s', implode(', ', $allowedFormats), PHP_EOL);
    exit(1);
}

if (empty($repo) || empty($owner) || empty($prNumber)) {
    echo "Usage: {$argv[0]} --owner=OWNER --repo=REPO --pr=PR_NUMBER\n";
    echo "Required:\n";
    echo "  --owner=OWNER           Repository owner\n";
    echo "  --repo=REPO             Repository name\n";
    echo "  --pr=NUMBER             Pull request number\n";
    echo "Optional:\n";
    echo "  --format=FORMAT         Output format: json, csv, table (default: table)\n";
    echo "Example: {$argv[0]} --owner=anthropics --repo=claude-code --pr=123\n";
    exit(1);
}

// First, get PR details
$prUrl = "https://api.github.com/repos/{$owner}/{$repo}/pulls/{$prNumber}";

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $prUrl);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    "Authorization: Bearer {$token}",
    "Accept: application/vnd.github+json",
    "X-GitHub-Api-Version: 2022-11-28",
    "User-Agent: PHP-GitHub-Client"
]);

$prResponse = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

if (curl_errno($ch)) {
    echo "cURL Error: " . curl_error($ch) . "\n";
    curl_close($ch);
    exit(1);
}

curl_close($ch);

if ($httpCode !== 200) {
    echo "API Error (HTTP {$httpCode}): {$prResponse}\n";
    exit(1);
}

$prData = json_decode($prResponse, true);

// Now get commits
$commitsUrl = "https://api.github.com/repos/{$owner}/{$repo}/pulls/{$prNumber}/commits";

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $commitsUrl);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    "Authorization: Bearer {$token}",
    "Accept: application/vnd.github+json",
    "X-GitHub-Api-Version: 2022-11-28",
    "User-Agent: PHP-GitHub-Client"
]);

$apiResponse = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

if (curl_errno($ch)) {
    echo "cURL Error: " . curl_error($ch) . "\n";
    curl_close($ch);
    exit(1);
}

curl_close($ch);

if ($httpCode !== 200) {
    echo "API Error (HTTP {$httpCode}): {$apiResponse}\n";
    exit(1);
}

// Decode the JSON response
$commits = json_decode($apiResponse, true);
if (empty($commits)) {
    echo "No commits found in this PR.\n";
    exit(0);
}

$responseItems = [];
foreach ($commits as $commit) {
    $responseItems[] = [
        'sha' => substr($commit['sha'], 0, 7),
        'fullSha' => $commit['sha'],
        'author' => $commit['commit']['author']['name'],
        'email' => $commit['commit']['author']['email'],
        'date' => date('Y-m-d H:i', strtotime($commit['commit']['author']['date'])),
        'message' => explode("\n", $commit['commit']['message'])[0],
    ];
}

if ($format === 'json') {
    $output = [
        'pr' => [
            'number' => $prData['number'],
            'title' => $prData['title'],
            'state' => $prData['state'],
            'author' => $prData['user']['login'],
            'base' => $prData['base']['ref'],
            'head' => $prData['head']['ref'],
            'url' => $prData['html_url'],
        ],
        'commits' => $responseItems,
    ];
    echo json_encode($output, JSON_PRETTY_PRINT);
    exit(0);
}

if ($format === 'csv') {
    $output = fopen('php://temp', 'r+');
    fputcsv($output, ['sha', 'author', 'email', 'date', 'message']);

    foreach ($responseItems as $item) {
        fputcsv($output, [
            $item['sha'],
            $item['author'],
            $item['email'],
            $item['date'],
            $item['message']
        ]);
    }

    rewind($output);
    $csvContent = stream_get_contents($output);
    fclose($output);
    echo $csvContent;
    exit(0);
}

if ($format === 'table') {
    echo "\n";
    echo "Pull Request #{$prData['number']}: {$prData['title']}\n";
    echo "Author: {$prData['user']['login']} | {$prData['base']['ref']} <- {$prData['head']['ref']}\n";
    echo "State: {$prData['state']} | URL: {$prData['html_url']}\n";
    echo str_repeat("-", 120) . "\n";

    $shaWidth = 9;
    $authorWidth = 20;
    $dateWidth = 16;
    $messageWidth = 70;

    printf("%-{$shaWidth}s | %-{$authorWidth}s | %-{$dateWidth}s | %-{$messageWidth}s\n",
        'SHA', 'Author', 'Date', 'Message');
    echo str_repeat("-", 120) . "\n";

    foreach ($responseItems as $item) {
        $message = strlen($item['message']) > $messageWidth
            ? substr($item['message'], 0, $messageWidth - 3) . '...'
            : $item['message'];
        $author = strlen($item['author']) > $authorWidth
            ? substr($item['author'], 0, $authorWidth - 3) . '...'
            : $item['author'];

        printf("%-{$shaWidth}s | %-{$authorWidth}s | %-{$dateWidth}s | %-{$messageWidth}s\n",
            $item['sha'], $author, $item['date'], $message);
    }

    echo str_repeat("-", 120) . "\n";
    echo "Total commits in PR: " . count($responseItems) . "\n\n";
}
